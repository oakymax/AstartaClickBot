# Структура бота в Botflow

## Конфигурация

### `config/telegraph.php`

Базовые настройки бота, предоставляемые библиотекой
[`defstudio/telegraph`](https://defstudio.github.io/telegraph/installation)

### `config/bot.php`

Декларативное описание логики поведения бота, выраженное в классах,
реализующих интерфейсы библиотеки `Botflow/Contracts`:

* `IBotMiddleware`: Middleware
* `IBotCommand`: Команды
* `IBotFlow`: Потоки
* `IBotAction`: Действия

## Middleware

Интерфейс: `IBotMiddleware`

Первичная обработка
обновления [`Update`](https://core.telegram.org/bots/api#update)

## Потоки выполнения

Интерфейс: `IBotFlow`

**BotFlow** / **Поток выполнения** – это класс, который описывает реакции бота
на
разные виды обновлений `FlowBed` в контексте конкретной задачи

**FlowBed** / **Русло Потока** – это обрабатываемый вид обновлений  
[`Update`](https://core.telegram.org/bots/api#update),
один из:

* `COMMAND` команда
* `MESSAGE` новое сообщение в чате
* `MESSAGE_UPDATE` изменение сообщения в чате
* `CHANNEL_POST` новое пост в канале
* `CHANNEL_POST_UPDATE` изменение поста в канале
* `CALLBACK_QUERY` callback query
* `INLINE_QUERY` inline query
* `CHAT_MEMBERS_JOINED` новый участник чата
* `CHAT_MEMBERS_LEFT` участник покинул чат

Все потоки реализуют интерфейс `IBotFlow`, содержащий методы обработки
для каждого поддерживаемого вида обновлений, а также отдельный метод
`handleUpdate`, который позволяет дополнительно описать общую реакцию на
обновление [`Update`](https://core.telegram.org/bots/api#update)

Основные потоки добавляются к поведению бота в ключе `flows` файла
конфигурации `config/bot.php`

Дополнительно потоки могут добавляться к поведению в ходе выполнения (внутри
кода потоков, команд, действий или middleware) с помощью
метода `IBotService::addFlow`. В рамках запроса контроль над поведением бота
последовательно передаётся всем зарегистрированным потокам, в том порядке в
котором они были зарегистрированы

Потоки обрабатываются в ходе обработки запроса после `middleware` и `/команд`

## Команды

Интерфейс: `IBotCommand`

Команда бота. Может быть выполнена как через телеграм при обращении к боту
командой `/{command-alias}`, либо в консоли:

```shell
sail artisan bot:command {--u=} {command-alias} {params?}
```

Параметр `--u` позволяет выполнить команду бота в консоли от лица конкретного
пользователя. По-умолчанию команды бота в консоли авторизуются от лица
`\App\User` с `id=1`

В потоке исполнения бот может регистрировать любое количество команд, в
зависимости от своей логики и текущего состояния контекста общения с
пользователем

**Ограничение:** `command-alias` должны быть
уникальными в рамках одного запроса, иначе бот упадёт с ошибкой
`RuntimeConfigurationErrorException`

В ходе обработки запроса команды обрабатываются после `middleware` перед `flows`

## Действия

Интерфейс: `IBotAction`

Действия, так же как и команды, могут выполняться и в чате с ботом в телеграме
и в консоли. Действия также регистрируются в потоке исполнения. Но действия, в
отличие от команд, не имеют `command-alias`, поэтому не могут быть запрошены
пользователем и не ограничены уникальностью типа (одно действие можно
выполнить много раз)

Действия выполняются на последнем шаге хода обработки запроса, после `middleware`,
`commands` и `flows`



