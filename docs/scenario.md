# Телеграм-бот MAER Group AIO на Laravel

## Настройка и запуск

1. copy .env.example -> .env
2. copy .docker.env.example -> .docker.env
3. copy docker-compose.{dev|prod}.yml -> docker-compose.yml
4. Откорректировать файлы .env и .docker.env
5. Выполнить команды:

```shell
docker-compose build
docker-compose up -d
docker-compose exec app composer install
docker-compose exec app php artisan key:generate
docker-compose exec app php artisan migrate
docker-compose exec app php artisan aio:setup-bot
(not for production) docker-compose exec app php artisan db:seed --class=DatabaseSeeder
```

Контейнер app может использоваться с
командой [sail](https://laravel.com/docs/10.x/sail):

```shell
./vendor/bin/sail artisan migrate
```

При использовании dev конфигурации в контейнере app
доступна [отладка через xdebug](https://laravel.com/docs/9.x/sail#xdebug-cli-usage),
с параметрами:

* docker/php/dev.php.ini: `xdebug.client_port = 9003`
* docker/php/dev.php.ini: `xdebug.idekey = PHPSTORM`
* docker-compose.dev.yml: `PHP_IDE_CONFIG: "serverName=aiobot.app"`

Для отладки консольных команд:

```shell
./vendor/bin/sail debug test
```

Установка alias для команды sail (можно прописать в .bashrc):

```shell
alias sail='[ -f sail ] && sh sail || sh vendor/bin/sail'
```

---

## Технические задание

### Основной запрос

Облегчить сбор отчетности самозанятых, автоматический прием данных от
сотрудников и получение ссылок на чеки

### Задача

Создать телеграм бота, который облегчил бы работу по сбору дынных.

### Функционал

Чат бот должен выполнять функции:

1. Добавление нового сотрудника в базу телефонных номеров
2. Определять отправителя идентифицируя его по номеру
3. Подтягивать из базы данные отправителя, чтобы отправителю не нужно было
   вводить данные в ручную.
4. Иметь возможность в ручную отправить по всей базе рассылку с запросом о
   предоставлении данных о чеках
5. получать от отправителя "Дату", "Сумму", "ссылку на чек" платежа.
6. Из полученных данных формировать письмо и отправлять его на емайл адреса
   которые укажет Оля.
7. Вести статистику отправленных данных
8. Сохранять все данные в базу
9. Срок хранения базы уточнить.

Данные:

* ФИО
* Плательщик от какой организации производилась выплата
* Почта рабочая
* Номер телефона сотовый
* Номер телефона внутренний

----

## Сценарии использования

* [X] список сотрудников импортируется в базу из файла с таблицей в обменном
  формате
* [X] при повторном импорте реестра сотрудников данные по уже имеющимся
  сотрудникам обновляются, а новые сотрудники добавляются
* управлять списком сотрудников администратор может как из админки, так и из
  телеграма:
    * добавление нового сотрудника
    * удаление сотрудника
    * изменение данных по сотруднику
* сотрудники отправляют боту запрос на регистрацию
    * для регистрации бот запрашивает контактные данные
    * при предоставлении контактных данных происходит автоматическое
      сопоставление с базой сотрудников по номеру телефона
    * если в базе найден сотрудник с таким номером телефона, то
        * система сопоставляет id пользователя в телеграме с сотрудником в базе
          сотрудников
        * пользователь получает роль "сотрудник Маер Групп"
        * пользователь получает уведомление об успешной регистрации и краткую
          инструкцию пользователя
        * в дальнейшем любое сообщение или команда телеграм боту трактуется в
          контексте авторизации пользователя
    * если в базе номер не найден, то
        * выдаётся сообщение о том что автоматически сопоставить с базой по
          номеру телефона не удалось
        * предлагается отправить заявку на регистрацию:
            * фамилия
            * имя
            * отчество
            * рабочий номер телефона
            * рабочая почта
            * есть ли регистрация самозанятого
        * если пользователь согласился оставить заявку и заполнил все поля, то
            * заявка поступает администраторам системы
            * администратор может просматривать/принимать/отклонять заявки на
              регистрацию как через админку так и через бота
            * при отклонении заявки пользователю отсылается сообщение в телеграм
              что заявка отклонена (с указанием причины)
            * при принятии заявки пользователь получает уведомление об успешной
              регистрации и краткую инструкцию пользователя
* администратор может вести списки сотрудников, разбивая их на группы. как через
  админку, так и через бота
* администратор может запросить чеки по выплатам как через админку, так и через
  бота
    * при запросе чеков зарегистрированным администратор указывает группу
      сотрудников, которым должны прийти уведомления
    * всем сотрудникам из указанной группы приходит сообщение в телеграм от бота
      о том что необходимо предоставить чек по выплате на самозанятого
    * (опционально) по отправленным уведомлениям администратор может смотреть
      статус (доставлено/не доставлено)
    * в уведомлении есть кнопка, которая позволяет сразу запустить форму
      отправки чека
    * такая же кнопка есть личном меню сотрудника, с помощью неё сотрудник может
      выслать чек в бухгалтерию в любое время без запроса
* форма отправки требует ввести следующие поля:
    * дата выплаты
    * организация, от которой была сделана выплата (из списка)
    * сумма выплаты
    * ссылка на чек (или файл чека)
* после отправки пользователь может видеть свой чек в реестре отправленных чеков
* администратор тоже может просматривать реестр полученных чеков как в админке
  так и с помощью бота
* как только все чеки будут собраны (или по истечении периода, который
  определяется администратором)
    * сводный отчёт по собранным чекам отправляется на email адреса, задаваемые
      администратором (в админке)
    * если чеки собраны не все, то администратор может отправить повторное
      уведомление тем кто не отправил чек
    * администратор видит реестр отправивших и не отправивших, и может перейти в
      диалог (в телеграме) с любым из сотрудников (например, для урегулирования
      вопроса о предоставлении чека в личном порядке)

На все нештатные варианты обращения бот реагирует рекомендацией использовать
регламент.

### Сценарий 1: Васечке скинули ссылку на бота

Васечка работает в MAER, получает ЗП как самозанятый, должен сдавать чеки в
бухгалтерию.
Васечка про бот узнал от руководства, ему сказали что бота надо слушаться.

Как всё было:

* Васечка переходит в бота, там написано "нажмите /start"
* Васечке приходится нажать старт, потому что это обязательно :(
* Васечка не теряется, видит что у бота есть меню, а там два пункта: Кабинет и
  Хелп!
* Васечка жмёт Кабинет, потому что он же сотрудник, знает за чем пришёл
* Васечка передумал и всё-таки жмёт Хелп! чтобы вдруг он чего не так понял
* А бот ему и говорит: так-то и так-то, у меня вот такие функции, а у тебя,
  Васечка, вот такие возможности
* Васечка сразу понял что к чему, и снова в меню, и выбрал там пункт "Кабинет"
* Бот Васечке честно говорит, что он его первый раз видит, и что для получения
  возможностей ему надо зарегистрироваться
* Стандартная клавитура под полем ввода у Васечки преобразуется и кастомными,
  кнопки такие:
    * Поделиться контактом
    * Отказаться
* Васечка если бы отказался, то бот бы просто пожелал ему всего хорошего, но
  Васечка выбрал поделиться контактом
* Бот контакт получил, и прошерстил его на предмет наличия телефона
    * Если в контакте не оказалось телефона, то
        * бот просто говорит что авторизация через смс будет через неделю и
          желает всего хорошего
        * кастомная клавиатура пропадает
        * конец сценария
    * Если в контакте телефон нашелся, но не нашёлся в базе сотрудников, то бот
      уже
        * печалится по этому поводу, и просит связаться с администрацией, тонко
          намекая на Олю
        * высылает Оле сообщение, что мол пресечена попытка представиться и
          палит контакт
        * кастомная клавиатура пропадает
        * конец сценария
    * Если в контакте нашёлся телефон и совпал с номером телефона одного из
      сотрудников в базе, то
        * кастомная клавиатура пропадает
        * игра продолжается
* Бот грорячо приветствует сотрудника по имени-отчеству и запоминает его
  надолго, чтобы болшье регистрацию не спрашивать
* Бот дополнительно высылает перечень полученных возможностей в виде справки
* Клавитура под полем ввода у Васечки превращается к клавиатуру Кабинета
  сотрудника MAER, кнопки такие:
    * Выслать чек от самозанятого
    * Написать в администрацию
    * Выйти из кабинета
* Васечка свои возможности ощущает через наблюдаемую клавиатуру, понимает что
  разобрался и
    * оставляет всё как есть, переключается на что-то поинтереснее
        * клавиатура в чате с ботом так и остаётся в режиме Кабинета, он может
          продолжить в любой момент
        * конец сценария
    * нажимает Выйти из кабинета. в сл. раз регистрация для входа в кабинет
      Васечке не потребуется
    * решает что нужно прямо сейчас выслать чек, потому что ему так сказали
        * не теряется, нажимает сразу конку Выслать чек
        * игра продолжается
* Далее следует диалог с Ботом (см. Обший сценарий диалога), в ходе которого бот
  запросит
    * Сумму платежа
    * Дату платежа
    * Ссылку на чек
    * Организация плательщик
* Если Васечка сдастся и выйдет из диалога, то это конец сценария
* Если Васечка не стастся и ответит на все вопросы, то бот
    * Запомнит когда кто, кому и сколько заплатил + ссылку на чек
    * Напишет куда следует что поступил чек (например в группу в телеграмме или
      в личку) + оперативную сводку за месяц, например
    * Если задано настройками, то и на почту продублирует информацию
* Васечке бот
    * скажет спасибо за ответственность от лица бухгалтерии
    * скажет, что если что-то где-то кто-то намудрил, то с ним свяжутся,
      возможно прямо тут же
* Клавиатура в диалоге бота остаётся в режиме Кабинет сотрудника MAER
* Конец сценария

### Общий сценарий диалога

В состоянии диалога Клавиатура кабинета MAER переходит в состояние диалога, т.е.
с кнопками:

* выйти из диалога
* выйти из кабинета

Диалог происходит, когда боту требуется последовательно задать пользователю
несколько вопросов и получить на них ответы.

* Бот сразу говорит, что сейчас начнётся диалог, для чего он, и что планируется
  спрашивать
* Бот задаёт следующий вопрос (начиная с первого), и начинает ждать ответ
* Если вопрос можно пропустить, то под сообщением с вопросом будет кнопка
  Пропустить вопрос, при нажатии которой бот
    * запомнит, что вопрос пропущен
    * напишет, что вопрос пропущен и вообще всё что он уже записал
* Если Васечка пишет что-то невнятное, не похожее на то что нужно, то
    * бот будет спрашивать то же самое
    * бот будет к этому добавлять что прервать диалог и начать всё заново можно
      если выйти из кабинета
* Как только Васечка введёт плюс-минус то что надо, бот
    * запомнит ответ
    * скажет спасибо и покажет Васечке всё что он уже записал
    * задаст следующий вопрос либо завершит диалог*
* В завершении диалога бот всегда
    * ещё раз напишет что именно принято к сведению
    * переспросит всё ли верно, предложит заполнить всё заново или отказаться

---

## Вопросы

* требуется реестр сотрудников маер в виде таблицы для импорта в базу
* какой период по-умолчанию отводится на сбор чеков после уведомления?

---

# Материалы по стеку

* Видео на канале
  AreaWeb: [Телеграм-бот на Laravel](https://www.youtube.com/watch?v=1J8l3pCc8p8)
* Документация [Laravel Telegraph](https://defstudio.github.io/telegraph/)
* Документация [Telegram Bot API](https://core.telegram.org/bots/api)
* Проект на
  Github: [Телеграм-бот на Laravel](https://github.com/somecode-pro/laravel-telegram-bot)
* Мануал по телеграм-ботам (на Pyhton
  3): [Урок 5. Клавиатуры и кнопки](https://surik00.gitbooks.io/aiogram-lessons/content/chapter5.html) 
