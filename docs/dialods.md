# Диалоги: общее описание

**Диалог** -- это объект, описывающий <ins>поведение бота с целью получения
информации от пользователя</ins>.

Подразумевается, что <ins>пользователь должен ответить на ряд вопросов, чтобы
бот получил достаточно информации для выполнения некоторой функции</ins>.

Пример: _Бот получил задачу на сбор чеков по платежам самозанятым. Для
выполнения этой задачи, он должен обратиться в форме диалога ко всем
зарегистрированным пользователям, которые числятся в базе как самозанятые, и
получить от них сведения о дате платежа, сумме, а также ссылку на чек_

Диалог монополизирует контроль за поведением бота в приватном чате. Пока диалог
активен, бот ожидает ответ на следующий вопрос. Два диалога одновременно с одним
пользователем в одном чате бот вести не может.

Структура диалога включает: Обращение, Вопросы и Завершение диалога.

## Обращение

Каждый диалог начинается с обращения `IBotDialog::intro`

Правило хорошего тона:

```
В приветственном сообщении бот предупреждает пользователя о начале диалога, 
а также сообщает цель диалога и какие данные ему требуется получить
```

## Вопросы

Далее задаётся ряд [вопросов](#IBotDialogQuestion), каждый из которых
обрабатывается примерно следующим образом:

* бот отправляет сообщение с формулировкой вопроса (и инструкцией о том в каком
  формате ожидается ответ, если она требуется в контексте)
* бот переходит в состояние ожидания ответа (каждое следующее сообщение
  пользователя, за исключением `/команд`, будет трактоваться как попытка дать
  ответ на заданный вопрос)
* в зависимости от дальнейшего поведения пользователя
    * при получении сообщения или callbackQueryResult (кнопка в сообщении) ответ
      валидируется и
        * если ответ прошёл валидацию
            * ответ запоминается
            * на сообщение с ответом ставится реакция OK
            * бот задаёт следующий вопрос или переходит к завершению диалога
        * если ответ не прошел валидацию
            * бот переспрашивает, пока от пользователя не поступит корректный
              ответ или пока не прервётся диалог
    * при продолжительном ожидании бот может переспросить методом `askAgain` или
      завершить
      диалог методом `interrupt`
    * при выполнении команды `/stop` диалог прерывается (все остальные
      зарегистрированные команды выполняются только при наличии у них
      флага `ignoreContext`)

## Завершение диалога

После получения ответы на все вопросы бот завершает диалог, например:

* Удаляет из чата все сообщения с некорректными ответами и переспрашиваниями
* Отправляет сообщение пользователю

Правило хорошего тона:

```
При завершении диалога хорошо бы поблагодарить пользователя и 
сообщить ему ещё раз какие данные приняты к сведению.
```

# Диалоги: структура кода

## BoflowDialogManager

Отвечает за поведение диалогов в общей структуре потоков:

* Монополизация диалогом контроля над поведением бота в приватном чате
* Хранение контекста, создание и завершение диалогов
* Последовательность реакций бота на сообщения. Сами реакции определяются
  методами контрактов
  [`IBotDialog`](#IBotDialog), [`IBotDialogQuestion`](#IBotDialogQuestion))
* Удаление лишних сообщений в ходе диалога и общие реакции на сообщения
* Фиксация действий пользователя и сохранение контекста
* Восстановление контекста диалога при получении сообщения от пользователя
* Обработка системных событий
    * истечение заданного времени ответа на вопрос
    * истечение актуальности вопроса или диалога в целом
    * внешний запрос на прерывание диалога

## IBotDialog

Контракт класса для диалога включает методы:

* обращение `intro`
* успешное завершение `succeed`
* прерывание пользователем `stop`
* прерывание системой (например, истечение срока давности ответа) `interrupt`

## IBotDialogQuestion

Контракт класса для вопроса в рамках диалога включает методы:

* формулировка вопроса `ask`
* валидация ответа `validate`
* обработка прерывания пользователем `stop`
* обработка системного прерывания `interrupt`

## SimpleConfigurableDialog

Простой конфигурируемый диалог. Позволяет полностью определить диалог через
массив параметров, в следующем формате:

```php
$dialog = [
    "intro" => "Для регистрации предоставьте данные о себе: фамилия, имя, отчество, пол и дата рождения",
    "outro" => [
        "message" => <<<TEXT
Спасибо! 
На регистрацию переданы следующие данные:
* Фамилия: {last_name}
* Имя: {first_name}
* Отчество: {middle_name}
* Пол: {gender}
* Дата рождения: {birthday}
TEXT,
        "delegateResultTo" => RegistrationDataReceivedEvent::class
    ],
    "questions" => $questions
];
```

## SimpleConfigurableDialogQuestion

Простой конфигурируемый вопрос для диалога. Позволяет полностью определить
вопрос через массив параметров, в следующем формате:

```php
$questions = [
    "last_name" => [
        "question" => "Напишите свою фамилию",
        "rules" => [
            [
                "rule" => "string|max:255",
                "message" => "Извините, это не похоже на фамилию. Попробуйте ещё раз. Длина должна быть не больше 255 символов"
            ],
        ]
    ],
    "first_name" => [
        "question" => "Напишите своё имя",
        "rules" => [
            [
                "rule" => "string|max:255",
                "message" => "Извините, это не похоже на имя. Попробуйте ещё раз. Длина должна быть не больше 255 символов"
            ],
        ]
    ],
    "middle_name" => [
        "question" => "Напишите своё отчество",
        "optional" => true,
        "rules" => [
            [
                "rule" => "string|max:255",
                "message" => "Извините, это не похоже на имя. Попробуйте ещё раз. Длина должна быть не больше 255 символов"
            ],
        ]
    ],
    "gender" => [
        "question" => "Какого вы пола?",
        "inlineAnswers" => [
            "male" => "М",
            "female" => "Ж"
        ]
    ],
    "birthday" => [
        "question" => "Напишите дату рождения. Формат: ГГГГ-ММ-ДД",
        "optional" => true,
        "rules" => [
            [
                "rule" => "date",
                "message" => "Извините, это не похоже на дату. Попробуйте ещё раз. Формат: ГГГГ-ММ-ДД"
            ],          
        ]   
    ]
];
```

###





